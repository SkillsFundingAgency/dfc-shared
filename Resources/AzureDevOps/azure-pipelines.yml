resources:
  repositories:
  - repository: self
  - repository: dfc-devops
    type: github
    name: SkillsFundingAgency/dfc-devops
    endpoint: 'GitHub (ESFA)'
    ref: refs/tags/v1.2.1
  - repository: dfc-devops-test
    type: github
    name: SkillsFundingAgency/dfc-devops
    endpoint: 'GitHub (ESFA)'
    ref: refs/heads/NCSD-2203-AddArmDeployTemplate

pr:
  branches:
    include:
    - master

stages:

- stage: Build
  jobs:
  - job: TestAndPublish
    pool:
      name: 'NCS - CI and CD'
    variables:
      - group: 'KeyVault - dfc-dev-shared-kv'
      - group: dfc-shared-infrastructure-dev
    steps:
    # ARM template
    - task: TotalALM.totalalm-tokenization.tokenization-build-task.Tokenization@2
      displayName: 'Tokenization: Transform file parameters.json'
      inputs:
        SourcePath: '$(System.DefaultWorkingDirectory)\Resources'
        TargetFileNames: test-parameters.json
    - template: AzureDevOpsTemplates/Build/dfc-arm-build.yml@dfc-devops
      parameters:
        ArmTemplateRoot: '$(System.DefaultWorkingDirectory)\Resources'
        steps:
    - task: CopyFiles@2
      displayName: 'Copy PSScripts Files to: $(Build.ArtifactStagingDirectory)'
      inputs:
        Contents: 'PSScripts/**/*.ps1'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
    - task: PublishPipelineArtifact@0
      displayName: Publish Pipeline Artifact
      inputs:
        targetPath: $(Build.ArtifactStagingDirectory)
        artifactName: Dfc.Shared
    # Also publish build artifact for backwards compatibility
    - task: PublishBuildArtifacts@1
      displayName: Publish Build Artifact
      inputs:
        pathtoPublish: $(Build.ArtifactStagingDirectory)
        artifactName: drop

- stage: DeployToDev
  variables:
  - group: dfc-shared-all
  - group: dfc-shared-infrastructure-all
  - template: VariableTemplates\SharedEnvironmentVariables.yml
  - group: 'KeyVault - dfc-dev-shared-kv'
  - group: dfc-shared-dev
  - group: dfc-shared-infrastructure-dev
  - group: dfc-cds-dev
  - template: VariableTemplates\DevEnvironmentVariables.yml
  jobs:
  - template: JobTemplates\Deploy.yml
    parameters:
      AzureSubscription: 'SFA-CDH-Dev/Test (962cae10-2950-412a-93e3-d8ae92b17896)'
      AksAdClientApplicationName: $(AksAdClientApplicationName)
      AksAdServerApplicationName: $(AksAdServerApplicationName)
      AksServicePrincipalName: $(AksServicePrincipalName)
      DfcDevOpsScriptRoot: '$(System.DefaultWorkingDirectory)'
      envAbbreviation: ${{ variables.envAbbreviation }}
      Environment: 'DEV_SHARED'
      EnvironmentTag: ${{ variables.EnvironmentTag }}
      resourceGroup: ${{ variables.resourceGroup }}
      ParentBusinessTag: ${{ variables.ParentBusinessTag }}
      ServiceOfferingTag: ${{ variables.ServiceOfferingTag }}
      SharedKeyVaultName: $(sharedKeyVaultName)