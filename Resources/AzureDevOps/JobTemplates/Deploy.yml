parameters:
  AzureSubscription: ''
  AksAdClientApplicationName: ''
  AksAdServerApplicationName: ''
  AksServicePrincipalName: ''
  ApimApisToRemove: '"Echo API"' #Comma seperated list of strings wrapped in double quotes
  CertificateIssuerAccountId: ''
  CertificateIssuerAdministratorPhoneNumber: ''
  CertificateIssuerPassword: ''
  DfcDevOpsScriptRoot: ''
  envAbbreviation: ''
  Environment: ''
  EnvironmentTag: ''
  ResourceGroup: ''
  ParentBusinessTag: ''
  ServiceOfferingTag: ''
  SharedKeyVaultName: ''
  SharedPrefix: ''
  StorageAccountName: ''

pool:
  name: 'NCS - CI and CD'

jobs:
- deployment: DeployTo_${{ parameters.Environment }}
  variables:
    SetTagsScriptUrl: https://raw.githubusercontent.com/SkillsFundingAgency/dfc-devops/master/PSScripts/Set-EsfaResourceGroupTags.ps1
    SetTagsScriptFilePath: $(System.DefaultWorkingDirectory)\Set-EsfaResourceGroupTags.ps1
    New-ApplicationRegistrationScriptUrl: https://raw.githubusercontent.com/SkillsFundingAgency/dfc-devops/master/PSScripts/New-ApplicationRegistration.ps1
    New-ApplicationRegistrationScriptFilePath: $(System.DefaultWorkingDirectory)\New-ApplicationRegistration.ps1
    Add-AzureAdApiPermissionsToAppScriptUrl: https://raw.githubusercontent.com/SkillsFundingAgency/dfc-devops/master/PSScripts/Add-AzureAdApiPermissionsToApp.ps1
    Add-AzureAdApiPermissionsToAppScriptFilePath: $(System.DefaultWorkingDirectory)\Add-AzureAdApiPermissionsToApp.ps1
    New-TableOnStorageAccountScriptUrl: https://raw.githubusercontent.com/SkillsFundingAgency/dfc-devops/master/PSScripts/New-TableOnStorageAccount.ps1
    New-TableOnStorageAccountScriptFilePath: $(System.DefaultWorkingDirectory)\New-TableOnStorageAccount.ps1
  environment: ${{ parameters.Environment }}
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzurePowerShell@3
          displayName: 'Azure PowerShell script: Set-ArmParameters'
          inputs:
            azureSubscription: ${{ parameters.AzureSubscription }}
            ScriptPath:  '$(Pipeline.Workspace)/Dfc.Shared.Resources.PSScripts/Set-ArmParameters.ps1'
            ScriptArguments: '-Environment "${{ parameters.envAbbreviation }}" -Verbose'
            azurePowerShellVersion: LatestVersion
        # Download scripts and create AKS service principals
        - task: PowerShell@2
          name: DownloadNewApplicationRegistrationScript
          displayName: 'Download New-ApplicationRegistration script'
          inputs:
            targetType: 'inline'
            script: Invoke-WebRequest -Uri $(New-ApplicationRegistrationScriptUrl) -OutFile $(New-ApplicationRegistrationScriptFilePath)
        - task: PowerShell@2
          name: DownloadAddAzureAdApiPermissionsToAppScript
          displayName: 'Download Add-AzureAdApiPermissionsToApp script'
          inputs:
            targetType: 'inline'
            script: Invoke-WebRequest -Uri $(Add-AzureAdApiPermissionsToAppScriptUrl) -OutFile $(Add-AzureAdApiPermissionsToAppScriptFilePath)
        - task: AzurePowerShell@3
          displayName: 'Azure PowerShell script: New-AksServicePrincipals.ps1'
          inputs:
            azureSubscription: ${{ parameters.AzureSubscription }}
            ScriptPath: '$(Pipeline.Workspace)/Dfc.Shared.Resources.PSScripts/New-AksServicePrincipals.ps1'
            ScriptArguments: '-AksServicePrincipalName ${{ parameters.AksServicePrincipalName }} -AksAdClientApplicationName ${{ parameters.AksAdClientApplicationName }} -AksAdServerApplicationName ${{ parameters.AksAdServerApplicationName }} -DfcDevOpsScriptRoot ${{ parameters.DfcDevOpsScriptRoot }} -SharedKeyVaultName ${{ parameters.SharedKeyVaultName }} -Verbose'
            azurePowerShellVersion: LatestVersion
        # Download script and create shared configuration table
        - task: PowerShell@2
          name: DownloadNewTableOnStorageAccountScript
          displayName: 'Download New-TableOnStorageAccount script'
          inputs:
            targetType: 'inline'
            script: Invoke-WebRequest -Uri $(New-TableOnStorageAccountScriptUrl) -OutFile $(New-TableOnStorageAccountScriptFilePath)
        - task: AzurePowerShell@4
          displayName: 'Create shared configuration table'
          inputs:
            azureSubscription: ${{ parameters.AzureSubscription }}
            ScriptPath: $(New-TableOnStorageAccountScriptFilePath)
            ScriptArguments: '-StorageAccountName ${{ parameters.StorageAccountName }} -ResourceGroupName ${{ parameters.ResourceGroup }} -TableName Configuration'
            azurePowerShellVersion: LatestVersion
        # Deploy ARM template
        - template: AzureDevOpsTemplates/Deploy/StepTemplates/dfc-arm-deploy.yml@dfc-devops
          parameters:
            ArmTemplateRoot: '$(Pipeline.Workspace)/Dfc.Shared.Resources.ArmTemplates'
            AzureSubscription: ${{ parameters.AzureSubscription }}
            EnvironmentTag: ${{ parameters.EnvironmentTag }}
            ParentBusinessTag: ${{ parameters.ParentBusinessTag }}
            ResourceGroup: ${{ parameters.ResourceGroup }}
            ServiceOfferingTag: ${{ parameters.ServiceOfferingTag }}
        # Remove unneeded APIM APIs
        - task: AzurePowerShell@4
          displayName: 'Remove Default APIs from APIM'
          inputs:
            azureSubscription: ${{ parameters.AzureSubscription }}
            ##TO DO: remove this script from dfc-devops when merging this change back to master
            ScriptPath: '$(Pipeline.Workspace)/Dfc.Shared.Resources.PSScripts/Remove-ApisFromApiManagement.ps1'
            ScriptArguments: '-ApisToRemove @( ${{ parameters.ApimApisToRemove }} ) -ApimResourceGroup "${{ parameters.ResourceGroup }}" -ApimServiceName "${{ parameters.SharedPrefix }}-apim"'
            azurePowerShellVersion: LatestVersion
        # Set KeyVault certificate issuer (OAT, PP & PRD only)
        - task: AzurePowerShell@4
          condition: and(succeededOrFailed(), in('${{ parameters.Environment}}', 'OAT_SHARED', 'PP_SHARED', 'PRD_SHARED'))
          displayName: 'Azure PowerShell script: Set-KeyVaultCertificateIssuer'
          inputs:
            azureSubscription: '${{ parameters.AzureSubscription }}'
            ScriptPath: '$(Pipeline.Workspace)/Dfc.Shared.Resources.PSScripts/Set-KeyVaultCertificateIssuer.ps1'
            ScriptArguments: '-AdministratorPhoneNumber "${{ parameters.CertificateIssuerAdministratorPhoneNumber }}" -CertificateIssuerPassword "${{ parameters.CertificateIssuerPassword }}" -KeyVaultName "${{ parameters.SharedKeyVaultName }}" -CertificateIssuerAccountId "${{ parameters.CertificateIssuerAccountId }}"'
            azurePowerShellVersion: LatestVersion




